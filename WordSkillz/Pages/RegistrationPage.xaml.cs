using CommunityToolkit.Maui.Views;
using Newtonsoft.Json;
using System.ComponentModel.DataAnnotations;
using System.Net.Mail;
using System.Net;
using WordSkillz.Models;
using WordSkillz.Popup;
using System.Net.Mime;

namespace WordSkillz.Pages;

public partial class RegistrationPage : ContentPage
{
    User contextUser;
    List<User> Users;
    public RegistrationPage(User user)
    {
        InitializeComponent();
        LoadedDataAsync();
        if (user.Id != 0)
        {
            this.Title = "Редактирование профиля";
            LLogin.IsVisible = false;
            BRegister.Text = "Сохранить";
            SelectedPhoto.Source = ImageSource.FromStream(() => new MemoryStream(user.Image));
        }
        contextUser = user;
        BindingContext = contextUser;
    }

    private async Task LoadedDataAsync()
    {
        try
        {
            Users = await NetManager.Get<List<User>>("api/Users");
        }
        catch(Exception ex)
        {
            await Console.Out.WriteLineAsync(ex.Message);
        }
    }

    private void TapGestureRecognizerLogin_Tapped(object sender, TappedEventArgs e)
    {
        App.Current.MainPage = new LoginPage();
    }

    private async void TapGestureRecognizerImage_Tapped(object sender, TappedEventArgs e)
    {
        var dialog = await MediaPicker.PickPhotoAsync();

        if (dialog != null)
        {
            contextUser.Image = File.ReadAllBytes(dialog.FullPath);
            var selectedPhotoPath = dialog.FullPath;
            SelectedPhoto.Source = ImageSource.FromFile(selectedPhotoPath);
        }
    }

    private async void BRegister_Clicked(object sender, EventArgs e)
    {

        try
        {
            var error = string.Empty;
            var validationContext = new ValidationContext(contextUser);
            var results = new List<ValidationResult>();
            var user = Users.FirstOrDefault(x => x.Email == contextUser.Email);
            if (user != null)
                error += "Пользователь с таким email уже существует\n";
            if (!Validator.TryValidateObject(contextUser, validationContext, results, true))
            {
                foreach (var result in results)
                {
                    error += $"{result.ErrorMessage}\n";
                }
            }
            if (!string.IsNullOrWhiteSpace(error))
            {
                var registrateValidationPopup = new RegistrateValidationPopup(error);
                var popup = new CommunityToolkit.Maui.Views.Popup();
                popup.Content = registrateValidationPopup;
                popup.Color = Color.FromRgba(0, 0, 0, 0);
                App.Current.MainPage.ShowPopup(popup);
                return;
            }

            var userDTO = ToUserDTO(contextUser);

            if (contextUser.Id == 0)
            {
                await NetManager.Post("api/Users", userDTO);
                SendMail();
            }
            else
                await NetManager.Put($"api/Users/{userDTO.Id}", userDTO);


            if (contextUser.Id == 0)
                App.Current.MainPage = new LoginPage();
            else
                await Navigation.PopAsync();
        }
        catch
        {
            var noConnectionPopup = new NoConnectionPopup();
            var popup = new CommunityToolkit.Maui.Views.Popup();
            popup.Content = noConnectionPopup;
            popup.Color = Color.FromRgba(0, 0, 0, 0);
            App.Current.MainPage.ShowPopup(popup);
        }
    }

    private async void SendMail()
    {
        try
        {
            //string currentDirectory = AppDomain.CurrentDomain.BaseDirectory;
            //string htmlFilePath = Path.Combine(currentDirectory, "mailtemplate.html");
            //string htmlBody = File.ReadAllText(htmlFilePath);

            SmtpClient mySmtpClient = new SmtpClient("smtp.mail.ru")
            {
                UseDefaultCredentials = false,
                EnableSsl = true,
                Credentials = new NetworkCredential("wordskillz@mail.ru", "8Yq3JT71yz3HqnirmVw6"),
                Port = 587
            };

            MailAddress from = new MailAddress("wordskillz@mail.ru", "WordSkillz");
            MailAddress to = new MailAddress(contextUser.Email, contextUser.Name);

            MailMessage message = new MailMessage(from, to);
            message.Subject = "Спасибо за регистрацию!";
            message.IsBodyHtml = true;

            AlternateView htmlView = AlternateView.CreateAlternateViewFromString("<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\r\n<html dir=\"ltr\" xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:o=\"urn:schemas-microsoft-com:office:office\">\r\n\r\n<head>\r\n    <meta charset=\"UTF-8\" />\r\n    <meta content=\"width=device-width, initial-scale=1\" name=\"viewport\" />\r\n    <meta name=\"x-apple-disable-message-reformatting\" />\r\n    <meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\" />\r\n    <meta content=\"telephone=no\" name=\"format-detection\" />\r\n    <title></title>\r\n</head>\r\n\r\n<body>\r\n    <div dir=\"ltr\">\r\n        <table class=\"es-wrapper\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\">\r\n            <tbody>\r\n                <tr>\r\n                    <td class=\"esd-email-paddings\" valign=\"top\">\r\n                        <table cellpadding=\"0\" cellspacing=\"0\" class=\"es-header\" align=\"center\">\r\n                            <tbody>\r\n                                <tr>\r\n                                    <td class=\"esd-stripe\" align=\"center\" esd-custom-block-id=\"388981\">\r\n                                        <table bgcolor=\"#ffffff\" class=\"es-header-body\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\">\r\n                                            <tbody>\r\n                                                <tr>\r\n                                                    <td class=\"esd-structure es-p10t es-p10b es-p20r es-p20l\" align=\"left\">\r\n                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                            <tbody>\r\n                                                                <tr>\r\n                                                                    <td width=\"560\" class=\"es-m-p0r esd-container-frame\" valign=\"top\" align=\"center\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td align=\"center\" class=\"esd-empty-container\" style=\"display: none;\"></td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                </tr>\r\n                                                            </tbody>\r\n                                                        </table>\r\n                                                    </td>\r\n                                                </tr>\r\n                                            </tbody>\r\n                                        </table>\r\n                                    </td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                        <table cellpadding=\"0\" cellspacing=\"0\" class=\"es-content\" align=\"center\">\r\n                            <tbody>\r\n                                <tr>\r\n                                    <td class=\"esd-stripe\" align=\"center\">\r\n                                        <table class=\"es-content-body\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\">\r\n                                            <tbody>\r\n                                                <tr>\r\n                                                    <td class=\"esd-structure es-p20t es-p10b es-p20r es-p20l\" align=\"left\">\r\n                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                            <tbody>\r\n                                                                <tr>\r\n                                                                    <td width=\"560\" class=\"esd-container-frame\" align=\"center\" valign=\"top\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td align=\"center\" class=\"esd-block-image es-p10t es-p10b\" style=\"font-size: 0px;\"><a target=\"_blank\"><img class=\"adapt-img\" src=\"https://eiaubng.stripocdn.email/content/guids/CABINET_941acf178f176dfeb77f012ea6df739fa61125a25ad6c84cdb47dab8075e8d22/images/letterw.png\" alt=alt style=\"display: block;\" width=\"300\" /></a></td>\r\n                                                                                </tr>\r\n                                                                                <tr>\r\n                                                                                    <td align=\"center\" class=\"esd-block-text es-p20t es-p10b es-m-txt-c\">\r\n                                                                                        <h1 style=\"font-size: 46px; line-height: 100%;\">Спасибо что выбрали WordSkillz</h1>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                                <tr>\r\n                                                                                    <td align=\"center\" class=\"esd-block-text es-p5t es-p5b\">\r\n                                                                                        <p>Мы рады приветствовать вас среди наших пользователей. WordSkillz поможет вам в увлекательной и эффективной форме изучать новые языки. Пусть это путешествие будет для вас интересным и плодотворным!</p>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                </tr>\r\n                                                            </tbody>\r\n                                                        </table>\r\n                                                    </td>\r\n                                                </tr>\r\n                                                <tr>\r\n                                                    <td class=\"esd-structure es-p20t es-p20r es-p20l\" align=\"left\">\r\n                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                            <tbody>\r\n                                                                <tr>\r\n                                                                    <td width=\"560\" class=\"esd-container-frame\" align=\"center\" valign=\"top\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td align=\"center\" class=\"esd-block-text es-p15t es-p5b es-p20r es-p20l es-m-txt-c\">\r\n                                                                                        <h2>Наши мини игры</h2>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                </tr>\r\n                                                            </tbody>\r\n                                                        </table>\r\n                                                    </td>\r\n                                                </tr>\r\n                                                <tr>\r\n                                                    <td class=\"esd-structure esdev-adapt-off es-p10t es-p20r es-p20l\" align=\"left\">\r\n                                                        <table width=\"560\" cellpadding=\"0\" cellspacing=\"0\" class=\"esdev-mso-table\">\r\n                                                            <tbody>\r\n                                                                <tr>\r\n                                                                    <td class=\"esdev-mso-td\" valign=\"top\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" align=\"left\" class=\"es-left\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td width=\"45\" class=\"es-m-p0r esd-container-frame\" align=\"center\">\r\n                                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                                            <tbody>\r\n                                                                                                <tr>\r\n                                                                                                    <td align=\"center\" class=\"esd-block-image\" style=\"font-size: 0px;\"><a target=\"_blank\"><img src=\"https://eiaubng.stripocdn.email/content/guids/CABINET_887f48b6a2f22ad4fb67bc2a58c0956b/images/2851617878322771.png\" alt=alt style=\"display: block;\" width=\"35\" /></a></td>\r\n                                                                                                </tr>\r\n                                                                                            </tbody>\r\n                                                                                        </table>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                    <td width=\"20\"></td>\r\n                                                                    <td class=\"esdev-mso-td\" valign=\"top\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" class=\"es-right\" align=\"right\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td width=\"495\" class=\"es-m-p0r esd-container-frame\" align=\"center\">\r\n                                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                                            <tbody>\r\n                                                                                                <tr>\r\n                                                                                                    <td align=\"left\" class=\"esd-block-text es-p10t es-p10b es-m-p5t es-m-txt-l\">\r\n                                                                                                        <p><strong>Обзор слов:</strong> В этой мини-игре вы можете повторять слова, которые вы добавили, вместе с их переводами, чтобы лучше закрепить их в памяти.</p>\r\n                                                                                                    </td>\r\n                                                                                                </tr>\r\n                                                                                            </tbody>\r\n                                                                                        </table>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                </tr>\r\n                                                            </tbody>\r\n                                                        </table>\r\n                                                    </td>\r\n                                                </tr>\r\n                                                <tr>\r\n                                                    <td class=\"esd-structure esdev-adapt-off es-p10t es-p20r es-p20l\" align=\"left\">\r\n                                                        <table width=\"560\" cellpadding=\"0\" cellspacing=\"0\" class=\"esdev-mso-table\">\r\n                                                            <tbody>\r\n                                                                <tr>\r\n                                                                    <td class=\"esdev-mso-td\" valign=\"top\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" align=\"left\" class=\"es-left\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td width=\"45\" class=\"es-m-p0r esd-container-frame\" align=\"center\">\r\n                                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                                            <tbody>\r\n                                                                                                <tr>\r\n                                                                                                    <td align=\"center\" class=\"esd-block-image\" style=\"font-size: 0px;\"><a target=\"_blank\"><img src=\"https://eiaubng.stripocdn.email/content/guids/CABINET_887f48b6a2f22ad4fb67bc2a58c0956b/images/2851617878322771.png\" alt=alt style=\"display: block;\" width=\"35\" /></a></td>\r\n                                                                                                </tr>\r\n                                                                                            </tbody>\r\n                                                                                        </table>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                    <td width=\"20\"></td>\r\n                                                                    <td class=\"esdev-mso-td\" valign=\"top\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" class=\"es-right\" align=\"right\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td width=\"495\" class=\"es-m-p0r esd-container-frame\" align=\"center\">\r\n                                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                                            <tbody>\r\n                                                                                                <tr>\r\n                                                                                                    <td align=\"left\" class=\"esd-block-text es-p10t es-p10b es-m-p5t es-m-txt-l\">\r\n                                                                                                        <p><strong>Вспомни:</strong> Здесь вам нужно угадать перевод слова, но сам перевод скрыт.</p>\r\n                                                                                                    </td>\r\n                                                                                                </tr>\r\n                                                                                            </tbody>\r\n                                                                                        </table>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                </tr>\r\n                                                            </tbody>\r\n                                                        </table>\r\n                                                    </td>\r\n                                                </tr>\r\n                                                <tr>\r\n                                                    <td class=\"esd-structure es-p10t es-p20b es-p20r es-p20l esdev-adapt-off\" align=\"left\">\r\n                                                        <table width=\"560\" cellpadding=\"0\" cellspacing=\"0\" class=\"esdev-mso-table\">\r\n                                                            <tbody>\r\n                                                                <tr>\r\n                                                                    <td class=\"esdev-mso-td\" valign=\"top\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" align=\"left\" class=\"es-left\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td width=\"45\" class=\"es-m-p0r esd-container-frame\" align=\"center\">\r\n                                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                                            <tbody>\r\n                                                                                                <tr>\r\n                                                                                                    <td align=\"center\" class=\"esd-block-image\" style=\"font-size: 0px;\"><a target=\"_blank\"><img src=\"https://eiaubng.stripocdn.email/content/guids/CABINET_887f48b6a2f22ad4fb67bc2a58c0956b/images/2851617878322771.png\" alt=alt style=\"display: block;\" width=\"35\" /></a></td>\r\n                                                                                                </tr>\r\n                                                                                            </tbody>\r\n                                                                                        </table>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                    <td width=\"20\"></td>\r\n                                                                    <td class=\"esdev-mso-td\" valign=\"top\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" class=\"es-right\" align=\"right\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td width=\"495\" class=\"es-m-p0r esd-container-frame\" align=\"center\">\r\n                                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                                            <tbody>\r\n                                                                                                <tr>\r\n                                                                                                    <td align=\"left\" class=\"esd-block-text es-p10t es-p10b es-m-p5t es-m-txt-l\">\r\n                                                                                                        <p><strong>Догадайся:</strong> Эта игра проверяет вашу способность выбрать правильный перевод из четырех предложенных вариантов.</p>\r\n                                                                                                    </td>\r\n                                                                                                </tr>\r\n                                                                                            </tbody>\r\n                                                                                        </table>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                </tr>\r\n                                                            </tbody>\r\n                                                        </table>\r\n                                                    </td>\r\n                                                </tr>\r\n                                            </tbody>\r\n                                        </table>\r\n                                    </td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                        <table cellpadding=\"0\" cellspacing=\"0\" class=\"es-footer\" align=\"center\">\r\n                            <tbody>\r\n                                <tr>\r\n                                    <td class=\"esd-stripe\" align=\"center\" esd-custom-block-id=\"388980\">\r\n                                        <table class=\"es-footer-body\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" width=\"640\" style=\"background-color: transparent;\">\r\n                                            <tbody>\r\n                                                <tr>\r\n                                                    <td class=\"esd-structure es-p20t es-p20b es-p20r es-p20l\" align=\"left\">\r\n                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                            <tbody>\r\n                                                                <tr>\r\n                                                                    <td width=\"600\" class=\"esd-container-frame\" align=\"left\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td align=\"center\" class=\"esd-block-social es-p15t es-p15b\" style=\"font-size:0\">\r\n                                                                                        <table cellpadding=\"0\" cellspacing=\"0\" class=\"es-table-not-adapt es-social\">\r\n                                                                                            <tbody>\r\n                                                                                                <tr>\r\n                                                                                                    <td align=\"center\" valign=\"top\" esd-tmp-icon-type=\"youtube\"><a target=\"_blank\" href=\"https://github.com/c3n9/WordSkillz\"><img title=\"GitHub\" src=\"https://eiaubng.stripocdn.email/content/guids/CABINET_941acf178f176dfeb77f012ea6df739fa61125a25ad6c84cdb47dab8075e8d22/images/icons8github50.png\" alt=\"GitHub\" /></a></td>\r\n                                                                                                </tr>\r\n                                                                                            </tbody>\r\n                                                                                        </table>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                                <tr>\r\n                                                                                    <td align=\"center\" class=\"esd-block-text es-p35b\">\r\n                                                                                        <p>Manakov Arseny © 2024</p>\r\n                                                                                    </td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                </tr>\r\n                                                            </tbody>\r\n                                                        </table>\r\n                                                    </td>\r\n                                                </tr>\r\n                                            </tbody>\r\n                                        </table>\r\n                                    </td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                        <table cellpadding=\"0\" cellspacing=\"0\" class=\"es-content esd-footer-popover\" align=\"center\">\r\n                            <tbody>\r\n                                <tr>\r\n                                    <td class=\"esd-stripe\" align=\"center\" esd-custom-block-id=\"388983\">\r\n                                        <table class=\"es-content-body\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" width=\"600\" style=\"background-color: transparent;\" bgcolor=\"rgba(0, 0, 0, 0)\">\r\n                                            <tbody>\r\n                                                <tr>\r\n                                                    <td class=\"esd-structure es-p20\" align=\"left\">\r\n                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                            <tbody>\r\n                                                                <tr>\r\n                                                                    <td width=\"560\" class=\"esd-container-frame\" align=\"center\" valign=\"top\">\r\n                                                                        <table cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\r\n                                                                            <tbody>\r\n                                                                                <tr>\r\n                                                                                    <td align=\"center\" class=\"esd-empty-container\" style=\"display: none;\"></td>\r\n                                                                                </tr>\r\n                                                                            </tbody>\r\n                                                                        </table>\r\n                                                                    </td>\r\n                                                                </tr>\r\n                                                            </tbody>\r\n                                                        </table>\r\n                                                    </td>\r\n                                                </tr>\r\n                                            </tbody>\r\n                                        </table>\r\n                                    </td>\r\n                                </tr>\r\n                            </tbody>\r\n                        </table>\r\n                    </td>\r\n                </tr>\r\n            </tbody>\r\n        </table>\r\n    </div>\r\n</body>\r\n\r\n</html>", null, MediaTypeNames.Text.Html);
            message.AlternateViews.Add(htmlView);

            mySmtpClient.Send(message);

        }
        catch (Exception ex)
        {
            await Console.Out.WriteLineAsync(ex.Message);
        }
    }

    public UserDTO ToUserDTO(User user)
    {
        return new UserDTO
        {
            Id = user.Id,
            Name = user.Name,
            Email = user.Email,
            Password = user.Password,
            Image = user.Image,
            PhoneNumber = user.PhoneNumber,
            LearnedWordsCount = user.LearnedWordsCount,
            IncorrectAnswersCount = user.IncorrectAnswersCount,
            CorrectAnswersCount = user.CorrectAnswersCount
        };
    }
}
